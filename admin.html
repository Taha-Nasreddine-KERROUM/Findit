<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FindIt Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#0d0f14; --surface:#161820; --surface2:#1e2028; --surface3:#252830;
      --border:rgba(255,255,255,0.07); --text:#eef0f5; --muted:#6b7080;
      --accent:#5b8dff; --found:#22c97a; --lost:#4da6ff; --waiting:#8a8f9e;
      --recovered:#e8a838; --danger:#e05a5a; --radius:14px;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;display:flex;}
    a{color:inherit;text-decoration:none;}
    button{cursor:pointer;font-family:inherit;}

    /* â”€â”€ SIDEBAR â”€â”€ */
    .sidebar{
      width:220px;flex-shrink:0;background:var(--surface);
      border-right:1px solid var(--border);
      display:flex;flex-direction:column;
      position:fixed;top:0;left:0;bottom:0;z-index:50;
    }
    .sidebar-logo{
      display:flex;align-items:center;gap:10px;
      padding:20px 18px 16px;border-bottom:1px solid var(--border);
    }
    .logo-mark{
      width:34px;height:34px;border-radius:50%;
      background:var(--surface2);border:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;
      font-family:'Syne',sans-serif;font-weight:800;font-size:13px;
    }
    .logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:15px;}
    .logo-badge{font-size:10px;color:var(--recovered);margin-left:2px;font-weight:600;}

    .nav{flex:1;padding:10px 8px;display:flex;flex-direction:column;gap:2px;}
    .nav-item{
      display:flex;align-items:center;gap:10px;
      padding:9px 12px;border-radius:10px;font-size:13px;font-weight:400;
      color:var(--muted);transition:all 0.12s;position:relative;
    }
    .nav-item:hover{background:var(--surface2);color:var(--text);}
    .nav-item.active{background:rgba(91,141,255,0.1);color:var(--accent);}
    .nav-item .badge{
      margin-left:auto;background:var(--danger);color:#fff;
      font-size:10px;font-weight:700;padding:1px 6px;border-radius:50px;
      min-width:18px;text-align:center;
    }
    .nav-icon{width:16px;height:16px;flex-shrink:0;}
    .nav-sep{height:1px;background:var(--border);margin:6px 4px;}

    .sidebar-user{
      padding:14px 14px 18px;border-top:1px solid var(--border);
      display:flex;align-items:center;gap:9px;
    }
    .user-av{
      width:32px;height:32px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:11px;font-weight:700;color:#fff;flex-shrink:0;
    }
    .user-name{font-size:13px;font-weight:500;line-height:1.2;}
    .user-role{font-size:10px;color:var(--recovered);}
    .signout-btn{margin-left:auto;background:none;border:none;color:var(--muted);font-size:18px;padding:2px;transition:color 0.12s;}
    .signout-btn:hover{color:var(--danger);}

    /* â”€â”€ MAIN â”€â”€ */
    .main{margin-left:220px;flex:1;min-height:100vh;display:flex;flex-direction:column;}
    .topbar{
      padding:16px 28px;border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:14px;
      background:var(--surface);position:sticky;top:0;z-index:40;
    }
    .page-title{font-family:'Syne',sans-serif;font-weight:800;font-size:18px;}
    .page-sub{font-size:12px;color:var(--muted);margin-top:1px;}
    .topbar-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
    .btn{
      display:inline-flex;align-items:center;gap:6px;
      padding:8px 16px;border-radius:9px;font-size:13px;font-weight:500;border:none;
      transition:opacity 0.15s;
    }
    .btn:hover{opacity:0.8;}
    .btn-primary{background:var(--accent);color:#fff;}
    .btn-ghost{background:var(--surface2);border:1px solid var(--border);color:var(--text);}
    .btn-danger{background:rgba(224,90,90,0.15);border:1px solid rgba(224,90,90,0.3);color:var(--danger);}
    .btn-success{background:rgba(34,201,122,0.12);border:1px solid rgba(34,201,122,0.25);color:var(--found);}
    .btn-sm{padding:5px 12px;font-size:12px;}

    .content{padding:24px 28px;flex:1;}

    /* â”€â”€ PANELS â”€â”€ */
    .panel{display:none;}
    .panel.active{display:block;}

    /* â”€â”€ STAT CARDS â”€â”€ */
    .stat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin-bottom:24px;}
    .stat-card{
      background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);
      padding:16px;
    }
    .stat-value{font-family:'Syne',sans-serif;font-weight:800;font-size:26px;line-height:1;margin-bottom:4px;}
    .stat-label{font-size:11px;color:var(--muted);}
    .stat-card.accent .stat-value{color:var(--accent);}
    .stat-card.found  .stat-value{color:var(--found);}
    .stat-card.danger .stat-value{color:var(--danger);}
    .stat-card.warn   .stat-value{color:var(--recovered);}

    /* â”€â”€ SECTION HEADER â”€â”€ */
    .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
    .section-title{font-family:'Syne',sans-serif;font-weight:700;font-size:14px;}

    /* â”€â”€ TABLE â”€â”€ */
    .table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:24px;}
    table{width:100%;border-collapse:collapse;}
    thead tr{border-bottom:1px solid var(--border);}
    th{padding:10px 14px;text-align:left;font-size:11px;font-weight:600;color:var(--muted);letter-spacing:0.4px;text-transform:uppercase;white-space:nowrap;}
    td{padding:11px 14px;font-size:13px;border-bottom:1px solid var(--border);vertical-align:middle;}
    tr:last-child td{border-bottom:none;}
    tr:hover td{background:rgba(255,255,255,0.015);}

    /* â”€â”€ BADGES â”€â”€ */
    .role-badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:50px;font-size:10px;font-weight:600;}
    .rb-super{background:rgba(232,168,56,0.15);color:var(--recovered);border:1px solid rgba(232,168,56,0.3);}
    .rb-admin{background:rgba(91,141,255,0.12);color:var(--accent);border:1px solid rgba(91,141,255,0.25);}
    .rb-user{background:var(--surface2);color:var(--muted);border:1px solid var(--border);}
    .rb-banned{background:rgba(224,90,90,0.12);color:var(--danger);border:1px solid rgba(224,90,90,0.25);}

    .status-dot{width:7px;height:7px;border-radius:50%;display:inline-block;margin-right:5px;}
    .dot-found{background:var(--found);}
    .dot-lost{background:var(--lost);}
    .dot-waiting{background:var(--waiting);}
    .dot-recovered{background:var(--recovered);}
    .dot-pending{background:var(--recovered);}
    .dot-approved{background:var(--found);}
    .dot-rejected{background:var(--danger);}

    .user-cell{display:flex;align-items:center;gap:9px;}
    .user-av-sm{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff;flex-shrink:0;}
    .user-uid{font-size:11px;color:var(--muted);}

    /* â”€â”€ ACTION ROW â”€â”€ */
    .actions{display:flex;gap:6px;flex-wrap:wrap;}

    /* â”€â”€ REQUEST CARD â”€â”€ */
    .req-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px;transition:border-color 0.15s;}
    .req-card:hover{border-color:rgba(255,255,255,0.12);}
    .req-head{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
    .req-name{font-family:'Syne',sans-serif;font-weight:700;font-size:15px;}
    .req-meta{font-size:12px;color:var(--muted);margin-top:2px;}
    .req-reason{font-size:13px;color:#9ba1b0;line-height:1.55;margin-bottom:14px;padding:10px 12px;background:var(--surface2);border-radius:9px;border:1px solid var(--border);}
    .req-actions{display:flex;gap:8px;}

    /* â”€â”€ LOG â”€â”€ */
    .log-item{display:flex;align-items:flex-start;gap:12px;padding:11px 0;border-bottom:1px solid var(--border);}
    .log-item:last-child{border-bottom:none;}
    .log-icon{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
    .log-action{font-size:13px;font-weight:500;}
    .log-detail{font-size:11px;color:var(--muted);margin-top:1px;}
    .log-time{margin-left:auto;font-size:11px;color:var(--muted);white-space:nowrap;}

    /* â”€â”€ MODAL â”€â”€ */
    .modal-bg{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity 0.2s;}
    .modal-bg.open{opacity:1;pointer-events:all;}
    .modal-box{background:var(--surface);border:1px solid var(--border);border-radius:18px;padding:22px;width:100%;max-width:420px;transform:scale(0.97);transition:transform 0.25s cubic-bezier(0.34,1.2,0.64,1);}
    .modal-bg.open .modal-box{transform:scale(1);}
    .modal-title{font-family:'Syne',sans-serif;font-weight:800;font-size:16px;margin-bottom:14px;}
    .form-group{display:flex;flex-direction:column;gap:5px;margin-bottom:12px;}
    .form-label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.4px;}
    .form-select,.form-input{background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:8px 11px;color:var(--text);font-size:13px;outline:none;width:100%;font-family:'DM Sans',sans-serif;transition:border-color 0.15s;}
    .form-select:focus,.form-input:focus{border-color:rgba(91,141,255,0.35);}
    .modal-actions{display:flex;gap:8px;margin-top:16px;}

    /* â”€â”€ SEARCH BAR â”€â”€ */
    .search-bar{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:9px;padding:7px 12px;margin-bottom:14px;}
    .search-bar input{background:none;border:none;outline:none;color:var(--text);font-size:13px;width:100%;}
    .search-bar svg{color:var(--muted);flex-shrink:0;}

    /* â”€â”€ TOAST â”€â”€ */
    .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(8px);z-index:999;background:var(--surface2);border:1px solid var(--border);border-radius:50px;padding:8px 18px;font-size:13px;opacity:0;transition:all 0.2s;pointer-events:none;}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
    .toast.success{border-color:rgba(34,201,122,0.3);color:var(--found);}
    .toast.error{border-color:rgba(224,90,90,0.3);color:var(--danger);}

    /* â”€â”€ GATE â”€â”€ */
    #authGate{display:flex;align-items:center;justify-content:center;min-height:100vh;width:100%;}
    .gate-box{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:32px;width:100%;max-width:360px;text-align:center;}
    .gate-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:22px;margin-bottom:4px;}
    .gate-sub{font-size:13px;color:var(--muted);margin-bottom:24px;}
    .gate-email{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:11px 13px;color:var(--text);font-size:14px;outline:none;margin-bottom:10px;display:block;transition:border-color 0.2s;font-family:inherit;}
    .gate-email:focus{border-color:rgba(91,141,255,0.35);}
    .gate-btn{width:100%;padding:11px;background:var(--accent);border:none;border-radius:10px;color:#fff;font-size:14px;font-weight:600;margin-bottom:10px;}
    .gate-note{font-size:12px;color:var(--muted);}
    .gate-sent{display:none;text-align:center;}
    .gate-sent-icon{font-size:36px;margin-bottom:10px;}
    .gate-err{font-size:12px;color:var(--danger);margin-top:6px;display:none;}

    #appShell{display:none;}

    /* empty */
    .empty-row td{text-align:center;padding:32px;color:var(--muted);font-size:13px;}

    /* loading */
    .loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--muted);font-size:13px;gap:8px;}
    .spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.7s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* scrollbar */
    ::-webkit-scrollbar{width:3px;}
    ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
  </style>
</head>
<body>

<!-- â”€â”€ AUTH GATE â”€â”€ -->
<div id="authGate">
  <div class="gate-box">
    <div class="gate-logo">FindIt</div>
    <div class="gate-sub">Admin Dashboard â€” sign in to continue</div>
    <div id="gateForm">
      <input class="gate-email" type="email" id="gateEmail" placeholder="your@university.edu" onkeydown="if(event.key==='Enter')gateSignIn()">
      <div class="gate-err" id="gateErr">Please enter a valid email</div>
      <button class="gate-btn" onclick="gateSignIn()">Send sign-in link</button>
      <div class="gate-note">We'll email you a link. Admin access is checked after sign-in.</div>
    </div>
    <div class="gate-sent" id="gateSent">
      <div class="gate-sent-icon">ğŸ“¬</div>
      <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;margin-bottom:8px">Check your inbox</div>
      <div class="gate-note" id="gateSentMsg"></div>
    </div>
    <div id="gateAccessDenied" style="display:none">
      <div style="font-size:32px;margin-bottom:10px">ğŸš«</div>
      <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;margin-bottom:8px">Access Denied</div>
      <div class="gate-note">Your account does not have admin privileges. Contact a super admin to request access.</div>
      <button class="gate-btn" style="margin-top:16px" onclick="gateReset()">Try another account</button>
    </div>
  </div>
</div>

<!-- â”€â”€ APP SHELL â”€â”€ -->
<div id="appShell" style="display:none;width:100%">

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-mark">Fi</div>
      <div><div class="logo-text">FindIt <span class="logo-badge">Admin</span></div></div>
    </div>
    <div class="nav">
      <div class="nav-item active" onclick="showPanel('overview')" data-panel="overview">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
        Overview
      </div>
      <div class="nav-item" onclick="showPanel('requests')" data-panel="requests">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        Admin Requests
        <span class="badge" id="reqBadge" style="display:none">0</span>
      </div>
      <div class="nav-item" onclick="showPanel('users')" data-panel="users">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        Users
      </div>
      <div class="nav-item" onclick="showPanel('posts')" data-panel="posts">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Posts
      </div>
      <div class="nav-sep"></div>
      <div class="nav-item" onclick="showPanel('logs')" data-panel="logs">
        <svg class="nav-icon" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        Mod Log
      </div>
    </div>
    <div class="sidebar-user">
      <div class="user-av" id="sideAvatar" style="background:var(--accent)">?</div>
      <div>
        <div class="user-name" id="sideName">â€”</div>
        <div class="user-role" id="sideRole">â€”</div>
      </div>
      <button class="signout-btn" onclick="adminSignOut()" title="Sign out">â†©</button>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="main">
    <div class="topbar">
      <div>
        <div class="page-title" id="pageTitle">Overview</div>
        <div class="page-sub" id="pageSub">Platform health at a glance</div>
      </div>
      <div class="topbar-right">
        <button class="btn btn-ghost btn-sm" onclick="refreshCurrent()">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-5"/></svg>
          Refresh
        </button>
        <a href="index.html" class="btn btn-ghost btn-sm">â† Back to site</a>
      </div>
    </div>

    <div class="content">

      <!-- â”€â”€ OVERVIEW â”€â”€ -->
      <div class="panel active" id="panel-overview">
        <div class="stat-grid" id="statGrid">
          <div class="stat-card accent"><div class="stat-value" id="st-posts">â€”</div><div class="stat-label">Total Posts</div></div>
          <div class="stat-card found"><div class="stat-value" id="st-active">â€”</div><div class="stat-label">Active Posts</div></div>
          <div class="stat-card"><div class="stat-value" id="st-users">â€”</div><div class="stat-label">Members</div></div>
          <div class="stat-card danger"><div class="stat-value" id="st-banned">â€”</div><div class="stat-label">Banned</div></div>
          <div class="stat-card warn"><div class="stat-value" id="st-admins">â€”</div><div class="stat-label">Admins</div></div>
          <div class="stat-card warn"><div class="stat-value" id="st-pending">â€”</div><div class="stat-label">Pending Requests</div></div>
        </div>
        <div class="section-header"><div class="section-title">Pending Admin Requests</div><button class="btn btn-ghost btn-sm" onclick="showPanel('requests')">See all â†’</button></div>
        <div id="overviewRequests"><div class="loading"><div class="spinner"></div> Loadingâ€¦</div></div>
      </div>

      <!-- â”€â”€ ADMIN REQUESTS â”€â”€ -->
      <div class="panel" id="panel-requests">
        <div id="requestsList"><div class="loading"><div class="spinner"></div> Loadingâ€¦</div></div>
      </div>

      <!-- â”€â”€ USERS â”€â”€ -->
      <div class="panel" id="panel-users">
        <div class="search-bar">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" id="userSearch" placeholder="Search by name, uid, emailâ€¦" oninput="filterUsers()">
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr>
              <th>User</th><th>Role</th><th>Status</th><th>Points</th><th>Joined</th><th>Actions</th>
            </tr></thead>
            <tbody id="usersBody"><tr><td colspan="6" class="loading"><div class="spinner"></div> Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€ POSTS â”€â”€ -->
      <div class="panel" id="panel-posts">
        <div class="search-bar">
          <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" id="postSearch" placeholder="Search postsâ€¦" oninput="filterPosts()">
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr>
              <th>Title</th><th>Author</th><th>Status</th><th>Location</th><th>Date</th><th>Actions</th>
            </tr></thead>
            <tbody id="postsBody"><tr><td colspan="6" class="loading"><div class="spinner"></div> Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- â”€â”€ MOD LOG â”€â”€ -->
      <div class="panel" id="panel-logs">
        <div class="table-wrap" style="padding:0 16px">
          <div id="logsList"><div class="loading"><div class="spinner"></div> Loadingâ€¦</div></div>
        </div>
      </div>

    </div><!-- /content -->
  </main>
</div><!-- /appShell -->

<!-- â”€â”€ ROLE MODAL â”€â”€ -->
<div class="modal-bg" id="roleModal" onclick="if(event.target===this)closeRoleModal()">
  <div class="modal-box">
    <div class="modal-title">Change Role</div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:14px" id="roleModalSub">Changing role for <strong></strong></div>
    <div class="form-group">
      <label class="form-label">Role</label>
      <select class="form-select" id="roleSelect">
        <option value="user">User</option>
        <option value="admin">Admin</option>
        <option value="super_admin">Super Admin</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeRoleModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveRole()">Save</button>
    </div>
  </div>
</div>

<!-- â”€â”€ ALERT MODAL â”€â”€ -->
<div class="modal-bg" id="alertModal" onclick="if(event.target===this)closeAlertModal()">
  <div class="modal-box">
    <div class="modal-title">Send Alert to User</div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:14px" id="alertModalSub"></div>
    <div class="form-group">
      <label class="form-label">Message</label>
      <input class="form-input" id="alertMsg" placeholder="e.g. Please review our community guidelinesâ€¦">
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeAlertModal()">Cancel</button>
      <button class="btn btn-primary" onclick="sendAlert()">Send Alert</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script src="supabase.js"></script>
<script>
  // â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let ME = null;
  let ALL_USERS = [];
  let ALL_POSTS = [];
  let currentRoleTarget = null;
  let currentAlertTarget = null;

  // â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (async () => {
    const me = await sb.handleCallback();
    if (me) return boot(me);
    const restored = await sb.restoreSession();
    if (restored) return boot(restored);
    // show login gate
  })();

  async function boot(me) {
    ME = me;
    const role = me.profile.role;
    if (!['admin','super_admin'].includes(role)) {
      document.getElementById('gateForm').style.display = 'none';
      document.getElementById('gateSent').style.display = 'none';
      document.getElementById('gateAccessDenied').style.display = 'block';
      return;
    }
    // hide gate, show app
    document.getElementById('authGate').style.display = 'none';
    document.getElementById('appShell').style.display = 'flex';
    // fill sidebar user info
    document.getElementById('sideAvatar').style.background = me.profile.color;
    document.getElementById('sideAvatar').textContent = me.profile.initials;
    document.getElementById('sideName').textContent = me.profile.name;
    document.getElementById('sideRole').textContent = role === 'super_admin' ? 'Super Admin' : 'Admin';
    // load overview
    loadOverview();
  }

  // â”€â”€ AUTH GATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function gateSignIn() {
    const email = document.getElementById('gateEmail').value.trim();
    const errEl = document.getElementById('gateErr');
    if (!email || !email.includes('@')) { errEl.style.display='block'; return; }
    errEl.style.display = 'none';
    const ok = await sb.sendMagicLink(email);
    if (ok) {
      document.getElementById('gateForm').style.display = 'none';
      document.getElementById('gateSent').style.display = 'block';
      document.getElementById('gateSentMsg').textContent = `We sent a sign-in link to ${email}. Click it to continue. If your account has admin rights, you'll be brought here automatically.`;
    } else {
      errEl.textContent = 'Something went wrong. Check your email address.';
      errEl.style.display = 'block';
    }
  }
  function gateReset() {
    document.getElementById('gateAccessDenied').style.display = 'none';
    document.getElementById('gateForm').style.display = 'block';
    document.getElementById('gateEmail').value = '';
    sb.signOut();
  }
  async function adminSignOut() {
    await sb.signOut();
    location.reload();
  }

  // â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const PANEL_META = {
    overview: { title:'Overview', sub:'Platform health at a glance' },
    requests: { title:'Admin Requests', sub:'Review and approve or reject pending requests' },
    users:    { title:'Users', sub:'Manage members, roles, and bans' },
    posts:    { title:'Posts', sub:'Review and moderate all posts' },
    logs:     { title:'Moderation Log', sub:'All admin actions, newest first' },
  };

  function showPanel(id) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('panel-' + id).classList.add('active');
    document.querySelector(`.nav-item[data-panel="${id}"]`).classList.add('active');
    const m = PANEL_META[id] || {};
    document.getElementById('pageTitle').textContent = m.title || id;
    document.getElementById('pageSub').textContent = m.sub || '';
    if (id === 'overview') loadOverview();
    if (id === 'requests') loadRequests();
    if (id === 'users')    loadUsers();
    if (id === 'posts')    loadPosts();
    if (id === 'logs')     loadLogs();
  }

  function refreshCurrent() {
    const active = document.querySelector('.nav-item.active');
    if (active) showPanel(active.dataset.panel);
  }

  // â”€â”€ OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadOverview() {
    const stats = await sb.getStats();
    document.getElementById('st-posts').textContent   = stats.totalPosts;
    document.getElementById('st-active').textContent  = stats.activePosts;
    document.getElementById('st-users').textContent   = stats.totalUsers;
    document.getElementById('st-banned').textContent  = stats.bannedUsers;
    document.getElementById('st-admins').textContent  = stats.admins;
    document.getElementById('st-pending').textContent = stats.pendingRequests;
    if (stats.pendingRequests > 0) {
      const b = document.getElementById('reqBadge');
      b.textContent = stats.pendingRequests;
      b.style.display = '';
    }
    // show first 3 pending requests inline
    const reqs = await sb.getPendingRequests();
    const el = document.getElementById('overviewRequests');
    if (!reqs.length) { el.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:12px 0">No pending requests</div>'; return; }
    el.innerHTML = reqs.slice(0,3).map(r => reqCardHtml(r)).join('');
  }

  // â”€â”€ REQUESTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadRequests() {
    const reqs = await sb.getPendingRequests();
    const el = document.getElementById('requestsList');
    if (!reqs.length) { el.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:24px 0;text-align:center">No pending requests â€” you\'re all caught up.</div>'; return; }
    el.innerHTML = reqs.map(r => reqCardHtml(r)).join('');
  }

  function reqCardHtml(r) {
    return `
  <div class="req-card" id="req-${r.id}">
    <div class="req-head">
      <div>
        <div class="req-name">${esc(r.name)}</div>
        <div class="req-meta">${esc(r.email)} Â· <em>${esc(r.role_title)}</em> Â· ${formatDate(r.created_at)}</div>
      </div>
      <span style="font-size:11px;color:var(--muted)">u/${esc(r.requester_uid)}</span>
    </div>
    <div class="req-reason">${esc(r.reason)}</div>
    <div class="req-actions">
      <button class="btn btn-success btn-sm" onclick="approveRequest('${r.id}','${r.user_id}')">Approve â†’ Admin</button>
      <button class="btn btn-danger btn-sm" onclick="rejectRequest('${r.id}')">Reject</button>
    </div>
  </div>`;
  }

  async function approveRequest(reqId, userId) {
    await sb.setRole(userId, 'admin');
    await sb.reviewRequest(reqId, 'approved', ME.profile.id);
    await sb.logAction(ME.profile.id, 'promote', userId, null, 'Approved admin request');
    document.getElementById('req-' + reqId)?.remove();
    toast('Access granted â€” user is now Admin', 'success');
    loadOverview();
  }

  async function rejectRequest(reqId) {
    await sb.reviewRequest(reqId, 'rejected', ME.profile.id);
    await sb.logAction(ME.profile.id, 'reject_request', null, null, `Rejected request ${reqId}`);
    document.getElementById('req-' + reqId)?.remove();
    toast('Request rejected');
  }

  // â”€â”€ USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadUsers() {
    ALL_USERS = await sb.getAllUsers();
    renderUsers(ALL_USERS);
  }

  function filterUsers() {
    const q = document.getElementById('userSearch').value.toLowerCase();
    renderUsers(q ? ALL_USERS.filter(u =>
            (u.name||'').toLowerCase().includes(q) ||
            (u.uid||'').toLowerCase().includes(q)
    ) : ALL_USERS);
  }

  function renderUsers(users) {
    const tbody = document.getElementById('usersBody');
    if (!users.length) { tbody.innerHTML = '<tr><td colspan="6" class="empty-row">No users found</td></tr>'; return; }
    tbody.innerHTML = users.map(u => {
      const roleBadge = {
        super_admin: '<span class="role-badge rb-super">Super Admin</span>',
        admin:       '<span class="role-badge rb-admin">Admin</span>',
        user:        '<span class="role-badge rb-user">User</span>',
      }[u.role] || '';
      const statusBadge = u.is_banned ? '<span class="role-badge rb-banned">Banned</span>' : '<span style="font-size:11px;color:var(--found)">Active</span>';
      const isSelf = ME && u.id === ME.profile.id;
      const isSuperSelf = isSelf && u.role === 'super_admin';
      return `<tr>
      <td>
        <div class="user-cell">
          <div class="user-av-sm" style="background:${u.color||'#5b8dff'}">${esc(u.initials)}</div>
          <div><div>${esc(u.name)}</div><div class="user-uid">u/${esc(u.uid)}</div></div>
        </div>
      </td>
      <td>${roleBadge}</td>
      <td>${statusBadge}</td>
      <td>${u.points}</td>
      <td>${formatDate(u.created_at)}</td>
      <td>
        <div class="actions">
          ${!isSuperSelf ? `<button class="btn btn-ghost btn-sm" onclick="openRoleModal('${u.id}','${u.uid}','${u.role}')">Role</button>` : ''}
          ${!isSelf && !u.is_banned ? `<button class="btn btn-danger btn-sm" onclick="doBan('${u.id}','${u.uid}')">Ban</button>` : ''}
          ${!isSelf && u.is_banned  ? `<button class="btn btn-success btn-sm" onclick="doUnban('${u.id}','${u.uid}')">Unban</button>` : ''}
          ${!isSelf ? `<button class="btn btn-ghost btn-sm" onclick="openAlertModal('${u.id}','${u.uid}')">Alert</button>` : ''}
        </div>
      </td>
    </tr>`;
    }).join('');
  }

  // â”€â”€ POSTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadPosts() {
    ALL_POSTS = await sb.getPosts();
    renderPosts(ALL_POSTS);
  }

  function filterPosts() {
    const q = document.getElementById('postSearch').value.toLowerCase();
    renderPosts(q ? ALL_POSTS.filter(p =>
            (p.title||'').toLowerCase().includes(q) ||
            (p.author_uid||'').toLowerCase().includes(q) ||
            (p.location||'').toLowerCase().includes(q)
    ) : ALL_POSTS);
  }

  function renderPosts(posts) {
    const tbody = document.getElementById('postsBody');
    if (!posts.length) { tbody.innerHTML = '<tr><td colspan="6" class="empty-row">No posts found</td></tr>'; return; }
    tbody.innerHTML = posts.map(p => {
      const sc = {found:'dot-found',lost:'dot-lost',waiting:'dot-waiting',recovered:'dot-recovered'}[p.status]||'dot-found';
      return `<tr>
      <td style="max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(p.title)}</td>
      <td>
        <div class="user-cell">
          <div class="user-av-sm" style="background:${p.author_color||'#5b8dff'}">${esc(p.author_initials||'?')}</div>
          <span>u/${esc(p.author_uid)}</span>
        </div>
      </td>
      <td><span class="status-dot ${sc}"></span>${p.status}</td>
      <td style="font-size:12px;color:var(--muted)">${esc(p.location)}</td>
      <td style="font-size:12px;color:var(--muted)">${formatDate(p.created_at)}</td>
      <td>
        <div class="actions">
          <button class="btn btn-danger btn-sm" onclick="doDeletePost('${p.id}')">Delete</button>
        </div>
      </td>
    </tr>`;
    }).join('');
  }

  // â”€â”€ LOGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadLogs() {
    const logs = await sb.getModLogs();
    const el = document.getElementById('logsList');
    if (!logs.length) { el.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:24px;text-align:center">No actions logged yet</div>'; return; }
    const icons = {ban:'ğŸš«',unban:'âœ…',promote:'â¬†ï¸',demote:'â¬‡ï¸',delete_post:'ğŸ—‘',alert:'âš ï¸',reject_request:'âœ•'};
    const colors = {ban:'rgba(224,90,90,0.12)',unban:'rgba(34,201,122,0.12)',promote:'rgba(232,168,56,0.12)',demote:'rgba(91,141,255,0.12)',delete_post:'rgba(224,90,90,0.12)',alert:'rgba(232,168,56,0.12)'};
    el.innerHTML = logs.map(l => {
      const admin  = l.admin?.uid || 'unknown';
      const target = l.target?.uid;
      return `<div class="log-item">
      <div class="log-icon" style="background:${colors[l.action]||'var(--surface2)'}">${icons[l.action]||'â€¢'}</div>
      <div>
        <div class="log-action">${l.action.replace(/_/g,' ')}</div>
        <div class="log-detail">by u/${esc(admin)}${target ? ` â†’ u/${esc(target)}` : ''} ${l.note ? 'Â· '+esc(l.note) : ''}</div>
      </div>
      <div class="log-time">${formatDate(l.created_at)}</div>
    </div>`;
    }).join('');
  }

  // â”€â”€ USER ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openRoleModal(userId, uid, currentRole) {
    currentRoleTarget = { id: userId, uid };
    document.getElementById('roleModalSub').innerHTML = `Changing role for <strong>u/${esc(uid)}</strong>`;
    document.getElementById('roleSelect').value = currentRole;
    document.getElementById('roleModal').classList.add('open');
  }
  function closeRoleModal() { document.getElementById('roleModal').classList.remove('open'); }
  async function saveRole() {
    if (!currentRoleTarget) return;
    const role = document.getElementById('roleSelect').value;
    await sb.setRole(currentRoleTarget.id, role);
    await sb.logAction(ME.profile.id, role === 'user' ? 'demote' : 'promote', currentRoleTarget.id, null, `Set role to ${role}`);
    closeRoleModal();
    loadUsers();
    toast(`u/${currentRoleTarget.uid} is now ${role}`, 'success');
  }

  async function doBan(userId, uid) {
    await sb.banUser(userId, ME.profile.id, 'Banned via admin panel');
    loadUsers();
    toast(`u/${uid} has been banned`);
  }
  async function doUnban(userId, uid) {
    await sb.unbanUser(userId, ME.profile.id, 'Unbanned via admin panel');
    loadUsers();
    toast(`u/${uid} unbanned`, 'success');
  }

  function openAlertModal(userId, uid) {
    currentAlertTarget = { id: userId, uid };
    document.getElementById('alertModalSub').textContent = `Sending alert to u/${uid}`;
    document.getElementById('alertMsg').value = '';
    document.getElementById('alertModal').classList.add('open');
  }
  function closeAlertModal() { document.getElementById('alertModal').classList.remove('open'); }
  async function sendAlert() {
    if (!currentAlertTarget) return;
    const note = document.getElementById('alertMsg').value.trim();
    await sb.logAction(ME.profile.id, 'alert', currentAlertTarget.id, null, note);
    closeAlertModal();
    toast(`Alert sent to u/${currentAlertTarget.uid}`);
  }

  // â”€â”€ POST ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function doDeletePost(postId) {
    if (!confirm('Delete this post? This cannot be undone.')) return;
    await sb.deletePost(postId);
    await sb.logAction(ME.profile.id, 'delete_post', null, postId, 'Deleted via admin panel');
    loadPosts();
    toast('Post deleted');
  }

  // â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function esc(str) {
    return (str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function formatDate(iso) {
    if (!iso) return 'â€”';
    const d = new Date(iso);
    return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
  }
  function toast(msg, type = '') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast show' + (type ? ' ' + type : '');
    setTimeout(() => t.className = 'toast', 2400);
  }
</script>
</body>
</html>